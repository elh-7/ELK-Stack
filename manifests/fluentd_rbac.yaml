# ================================================================
# FLUENTD RBAC (Roles, Permisos y Cuenta de Servicio)
# Permite a Fluentd acceder a los metadatos de los Pods y Namespaces
# necesarios para enriquecer los logs con etiquetas y contexto.
# ================================================================

# ---------------------------------------------------------------
# 1. CLUSTERROLE
# Define los permisos que Fluentd tendrá dentro del clúster
# ---------------------------------------------------------------
apiVersion: rbac.authorization.k8s.io/v1   # Versión de la API de Kubernetes para control de acceso basado en roles (RBAC)
kind: ClusterRole                          # Tipo de recurso: ClusterRole otorga permisos a nivel global (todo el clúster)

metadata:
  name: fluentd                            # Nombre del rol; será referenciado por el ClusterRoleBinding

rules:                                     # Lista de reglas que definen los permisos del rol
- apiGroups: [""]                          # Grupo de API vacío indica recursos del núcleo (core API group)
  resources: ["pods", "namespaces"]        # Recursos a los que se permite acceso
  verbs: ["get","list","watch"]            # Acciones permitidas:
                                           # - get: leer un recurso específico
                                           # - list: listar todos los recursos
                                           # - watch: observar cambios en tiempo real
                                           # Estos permisos permiten a Fluentd identificar metadatos de Pods y Namespaces
                                           # para incluirlos en los logs recolectados.

---

# ---------------------------------------------------------------
# 2. SERVICEACCOUNT
# Crea la cuenta de servicio que usará Fluentd en el namespace "logging"
# ---------------------------------------------------------------
apiVersion: v1                             # Versión base de la API para recursos como ServiceAccount
kind: ServiceAccount                       # Tipo de recurso: ServiceAccount proporciona identidad a los Pods
metadata:
  name: fluentd                            # Nombre de la cuenta de servicio
  namespace: logging                       # Namespace donde será creada y utilizada (coincide con el DaemonSet de Fluentd)

# Esta ServiceAccount será asignada a los Pods de Fluentd mediante:
# spec.serviceAccountName: fluentd
# en el manifiesto del DaemonSet correspondiente.

---

# ---------------------------------------------------------------
# 3. CLUSTERROLEBINDING
# Asocia el ClusterRole con la ServiceAccount para otorgar los permisos definidos
# ---------------------------------------------------------------
apiVersion: rbac.authorization.k8s.io/v1   # API RBAC para las vinculaciones de roles
kind: ClusterRoleBinding                   # Tipo de recurso: ClusterRoleBinding enlaza roles con sujetos (ServiceAccounts, Usuarios, Grupos)

metadata:
  name: fluentd                            # Nombre de la vinculación (usualmente coincide con el rol para claridad)

roleRef:                                   # Referencia al rol que se va a vincular
  apiGroup: rbac.authorization.k8s.io      # Grupo API que contiene el rol
  kind: ClusterRole                        # Tipo de rol que se vincula
  name: fluentd                            # Nombre exacto del ClusterRole definido más arriba

subjects:                                  # Define los sujetos (entidades) a los que se otorgan los permisos
- kind: ServiceAccount                     # Tipo de sujeto: una cuenta de servicio
  name: fluentd                            # Nombre de la ServiceAccount que recibirá los permisos
  namespace: logging                       # Namespace donde existe la ServiceAccount

# ---------------------------------------------------------------
# RESUMEN FUNCIONAL:
# - ClusterRole: define permisos de lectura sobre Pods y Namespaces.
# - ServiceAccount: identidad usada por los Pods de Fluentd.
# - ClusterRoleBinding: vincula la ServiceAccount al rol global.
# 
# Este conjunto permite que Fluentd:
#   * Observe la creación y eliminación de Pods.
#   * Obtenga etiquetas y metadatos de Kubernetes.
#   * Enriquezca los registros con información contextual (namespace, pod, contenedor, etc.).
# ---------------------------------------------------------------
