apiVersion: v1                               # Versión de la API usada para objetos básicos de Kubernetes (ConfigMap pertenece al grupo "core")
kind: ConfigMap                              # Tipo de recurso: almacena configuraciones en formato clave-valor accesibles por pods
metadata:                                    # Metadatos del objeto
  name: fluentd-config                       # Nombre del ConfigMap (identificador único dentro del namespace)
  namespace: logging                         # Namespace donde se despliega la configuración
data:                                        # Sección donde se definen las claves y sus datos asociados
  fluent.conf: |                             # Clave "fluent.conf" cuyo valor es un bloque de texto (configuración del agente Fluentd)
                                             
    <source>                                            # Bloque que define una fuente de datos (de dónde Fluentd obtendrá los logs)
      @type tail                                        # Tipo de entrada: "tail" lee archivos de log línea por línea, como el comando Linux 'tail -f'
      path /var/log/containers/*.log                    # Ruta de los archivos de logs de contenedores (montados por kubelet en el nodo)
      pos_file /var/log/fluentd-containers.log.pos      # Archivo donde Fluentd guarda su posición de lectura para evitar duplicar logs tras reinicios
      tag kubernetes.*                                  # Etiqueta asignada a los eventos leídos; aquí todos los logs tendrán prefijo "kubernetes."
      format multiline                                  # Indica que los logs pueden abarcar varias líneas (por ejemplo, trazas de errores)
      format_firstline /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/
                                                        # Expresión regular que detecta el inicio de una nueva entrada de log con formato de fecha ISO8601
      format1 /^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[FP]) (?<message>.*)$/
                                                        # Define cómo extraer campos (tiempo, flujo, etiqueta y mensaje) de cada línea de log
      time_format %Y-%m-%dT%H:%M:%S.%N%:z               # Formato temporal usado para interpretar las marcas de tiempo en los logs
    </source>

    <match kubernetes.**>                    # Bloque de salida: aplica a todos los logs cuyo tag comience con "kubernetes."
      @type elasticsearch                    # Tipo de destino: los logs se enviarán a Elasticsearch
      host elasticsearch                     # Host o nombre del servicio de Elasticsearch dentro del clúster
      port 9200                              # Puerto del servicio de Elasticsearch (por defecto para HTTP)
      scheme https                           # Protocolo de conexión seguro (HTTPS)
      ssl_verify false                       # Desactiva la verificación SSL (útil en entornos de prueba con certificados autofirmados)
      user elastic                           # Usuario de autenticación en Elasticsearch
      password TuPasswordSeguro              # Contraseña correspondiente (debe cambiarse por seguridad)
      index_name fluentd                     # Nombre del índice donde se almacenarán los logs
      logstash_format true                   # Formato compatible con Logstash (estructura de campos estándar)
      include_tag_key true                   # Incluye la clave de etiqueta (@log_name) en los registros almacenados
      tag_key @log_name                      # Define el nombre del campo donde se guardará la etiqueta del log
    </match>
