# ================================================================
# KIBANA DEPLOYMENT + SERVICE
# Despliega Kibana dentro del namespace "logging" y lo expone vía NodePort.
# Kibana permite visualizar, buscar y analizar logs almacenados en Elasticsearch.
# ================================================================

# ---------------------------------------------------------------
# 1. DEPLOYMENT
# Controla la creación y administración de Pods de Kibana.
# ---------------------------------------------------------------
---
apiVersion: apps/v1                       # Versión de la API usada para despliegues (Deployment)
kind: Deployment                          # Tipo de recurso: Deployment administra réplicas de Pods

metadata:
  name: kibana                            # Nombre del Deployment (debe ser único dentro del namespace)
  namespace: logging                      # Namespace donde se desplegará Kibana (consistente con los demás componentes)

spec:                                     # Especificación del Deployment
  replicas: 1                             # Número de réplicas (Pods) de Kibana a ejecutar. Puede incrementarse para alta disponibilidad.
  selector:                               # Define cómo Kubernetes identificará los Pods pertenecientes a este Deployment
    matchLabels:
      app: kibana                         # Coincide con las etiquetas del Pod Template (más abajo)
  
  template:                               # Plantilla que define cómo se crean los Pods gestionados por este Deployment
    metadata:
      labels:
        app: kibana                       # Etiqueta que identifica a los Pods (usada también por el Service para dirigir tráfico)
    
    spec:
      containers:                         # Lista de contenedores dentro del Pod (en este caso, uno: Kibana)
      - name: kibana                      # Nombre del contenedor
        image: docker.elastic.co/kibana/kibana:7.17.4  # Imagen oficial de Kibana versión 7.17.4 (compatible con Elasticsearch 7.x)
        
        ports:
        - containerPort: 5601             # Puerto expuesto por Kibana dentro del contenedor (interfaz web)
        
        env:                              # Variables de entorno para configurar la conexión con Elasticsearch y ajustes de seguridad
        - name: ELASTICSEARCH_HOSTS
          value: '["https://elasticsearch:9200"]'   # Dirección del servicio de Elasticsearch (usa el nombre DNS del Service interno)
        
        - name: ELASTICSEARCH_USERNAME
          value: "elastic"                # Usuario administrador de Elasticsearch; se recomienda usar un secreto en producción
        
        - name: ELASTICSEARCH_PASSWORD
          value: "TuPasswordSeguro"       # Contraseña asociada al usuario; debe reemplazarse por un Secret en entornos reales
        
        - name: SERVER_SSL_ENABLED
          value: "false"                  # Desactiva SSL en el servidor Kibana (útil en entornos internos o pruebas)
        
        - name: ELASTICSEARCH_SSL_VERIFICATIONMODE
          value: "none"                   # Desactiva la verificación SSL con Elasticsearch (solo para entornos sin certificados válidos)
          
# NOTA: Las variables de entorno anteriores pueden reemplazarse con Secrets:
#   valueFrom:
#     secretKeyRef:
#       name: elastic-credentials
#       key: password
# Esto mejora la seguridad y evita exponer credenciales en texto plano.

# ---------------------------------------------------------------
# 2. SERVICE
# Expone Kibana dentro y fuera del clúster mediante NodePort.
# ---------------------------------------------------------------
---
apiVersion: v1                            # Versión base de la API de Kubernetes para recursos de red (Service)
kind: Service                             # Tipo de recurso: Service gestiona el acceso de red a los Pods

metadata:
  name: kibana                            # Nombre del Service (usado como DNS interno: kibana.logging.svc.cluster.local)
  namespace: logging                      # Namespace donde reside el Service

spec:
  type: NodePort                          # Tipo de Service que expone el puerto a través de los nodos del clúster
                                          # Permite acceder a Kibana desde fuera del clúster usando IP del nodo + puerto NodePort.
                                          
  ports:                                  # Lista de puertos manejados por el Service
  - port: 5601                            # Puerto del Service dentro del clúster
    targetPort: 5601                      # Puerto del contenedor Kibana (debe coincidir con containerPort)
    nodePort: 30001                       # Puerto asignado en los nodos del clúster (acceso externo: <NodeIP>:30001)

  selector:
    app: kibana                           # Vincula el tráfico del Service a los Pods etiquetados con "app: kibana"

# ---------------------------------------------------------------
# RESUMEN FUNCIONAL:
# - Deployment: Crea y mantiene un Pod de Kibana conectado a Elasticsearch.
# - Variables de entorno: Configuran credenciales y conexión con el backend.
# - Service: Expone Kibana a través del puerto 30001 del nodo para acceso web.
#
# Acceso desde navegador (entorno local o remoto):
#   http://<IP_del_nodo>:30001
#
# Recomendaciones de producción:
#   * Reemplazar credenciales por Secrets.
#   * Activar SSL en Kibana y Elasticsearch.
#   * Limitar el acceso externo mediante Ingress o firewall.
# ---------------------------------------------------------------
